<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Skywalking on 李国宝</title><link>https://liguobao.github.io/tags/skywalking/</link><description>Recent content in Skywalking on 李国宝</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Fri, 21 Sep 2018 00:00:00 +0000</lastBuildDate><atom:link href="https://liguobao.github.io/tags/skywalking/index.xml" rel="self" type="application/rss+xml"/><item><title>每周开源项目分享-年轻人的第一个APM之Skywalking</title><link>https://liguobao.github.io/p/%E6%AF%8F%E5%91%A8%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%88%86%E4%BA%AB-%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AAapm%E4%B9%8Bskywalking/</link><pubDate>Fri, 21 Sep 2018 00:00:00 +0000</pubDate><guid>https://liguobao.github.io/p/%E6%AF%8F%E5%91%A8%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E5%88%86%E4%BA%AB-%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AAapm%E4%B9%8Bskywalking/</guid><description>&lt;h1 id="年轻人的第一个apm之skywalking">年轻人的第一个APM之Skywalking
&lt;/h1>&lt;h2 id="前言">前言
&lt;/h2>&lt;p>什么是APM?全称:Application Performance Management&lt;/p>
&lt;p>可以参考这里:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">现代APM体系，基本都是参考Google的Dapper（大规模分布式系统的跟踪系统）的体系来做的。通过跟踪请求的处理过程，来对应用系统在前后端处理、服务端调用的性能消耗进行跟踪，关于Dapper的介绍可以看这个链接：Dapper，大规模分布式系统的跟踪系统 by bigbully
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">作者：刀把五
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">链接：https://www.zhihu.com/question/27994350/answer/118821214
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">来源：知乎
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最早使用APM还是在携程里面搬砖的时候,当时使用的是大宗点评网开源的&lt;a class="link" href="https://github.com/dianping/cat" target="_blank" rel="noopener"
>dianping/cat&lt;/a>框架.&lt;/p>
&lt;p>后来到了新公司,因为历史包袱有点多,追踪性能问题太麻烦,用过收费的&lt;a class="link" href="https://newrelic.com/" target="_blank" rel="noopener"
>New Relic | Real-time insights for modern software&lt;/a> ,newrelic按照CPU核数和内存来收费,实在太贵了我们就放弃了.&lt;/p>
&lt;p>再后来我们调研一下市面的其他方案,看到了这个知乎讨论给了不少的东西.&lt;/p>
&lt;p>&lt;a class="link" href="https://www.zhihu.com/question/27994350" target="_blank" rel="noopener"
>有什么知名的开源apm(Application Performance Management)工具吗？&lt;/a>&lt;/p>
&lt;p>当时看到&lt;a class="link" href="https://github.com/naver/pinpoint" target="_blank" rel="noopener"
>naver/pinpoint&lt;/a> 和&lt;a class="link" href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener"
>apache/incubator-skywalking&lt;/a> 都很不错.&lt;/p>
&lt;p>一个是韩国搜索团队开源的,一个是国内个人用户开源,已经到了apache孵化器了.&lt;/p>
&lt;p>于是两个都试用了一下, 最后由于那时候马上考虑上分表分库组件 sharding-jdbc-dangdang, skywalking也要对应的支持,所以决定用skywalking试试.&lt;/p>
&lt;p>再后来又跑路了,不好意思给那边留下坑就没继续搭建看. 到了新公司PHP/Python/Java什么都写,开始两三个月也没管这个.&lt;/p>
&lt;p>最近不是太忙了,新公司这边服务端API暂时被我带成了dotnet core技术栈,233&amp;hellip;&lt;/p>
&lt;p>同时发现当前用的EF框架偶尔会因为不小心就写出了性能很差的SQL,测试环境基本看不出来,到了生产可能就炸.&lt;/p>
&lt;p>前阵子看到dalao &lt;a class="link" href="https://www.zhihu.com/people/liuhaoyang" target="_blank" rel="noopener"
>倾竹&lt;/a> 把dotnet core agent写出来了, 于是爽歪歪就开始gang了.&lt;/p>
&lt;h2 id="开始搭建skywalking">开始搭建skywalking
&lt;/h2>&lt;p>github:&lt;a class="link" href="https://github.com/apache/incubator-skywalking" target="_blank" rel="noopener"
>incubator-skywalking&lt;/a>&lt;/p>
&lt;p>当前release版本为5.0RC2,最新版本6.X正在开发中.&lt;/p>
&lt;p>所以当前我这里是基于5.0 RC2来搭建的.&lt;/p>
&lt;p>官方向导方案在这里:&lt;a class="link" href="https://github.com/apache/incubator-skywalking/blob/5.x/docs/README.md" target="_blank" rel="noopener"
>incubator-skywalking/blob/5.x/docs/README.md&lt;/a>&lt;/p>
&lt;p>中文文档在这里:&lt;a class="link" href="https://github.com/apache/incubator-skywalking/blob/5.x/docs/README_ZH.md" target="_blank" rel="noopener"
>incubator-skywalking/blob/5.x/docs/README_ZH.md&lt;/a>&lt;/p>
&lt;p>我这里今天还是全程docker部署.&lt;/p>
&lt;p>以下操作来自&lt;a class="link" href="https://github.com/JaredTan95/skywalking-docker" target="_blank" rel="noopener"
>JaredTan95/skywalking-docker&lt;/a> dalao准备的docker部署.&lt;/p>
&lt;p>预备条件:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>docker&lt;/p>
&lt;/li>
&lt;li>
&lt;p>elasticsearch&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="启动elasticsearch">启动Elasticsearch
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Elasticsearch版本要求5.x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker run -p 9200:9200 -p 9300:9300 -e cluster.name&lt;span class="o">=&lt;/span>elasticsearch -e xpack.security.enabled&lt;span class="o">=&lt;/span>&lt;span class="nb">false&lt;/span> --name&lt;span class="o">=&lt;/span>elasticsearch --restart&lt;span class="o">=&lt;/span>always -d wutang/elasticsearch-shanghai-zone
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动好了访问一下 &lt;a class="link" href="http://localhost:9200" target="_blank" rel="noopener"
>http://localhost:9200&lt;/a> 看看,看到一下的内容说明ES已经正常启动了.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;_PNUyiW&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;cluster_name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;elasticsearch&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;cluster_uuid&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;number&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5.6.10&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_hash&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;b727a60&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_date&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2018-06-06T15:48:34.860Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_snapshot&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;lucene_version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;6.6.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;tagline&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;You Know, for Search&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接着使用 docker inspect elasticsearch |grep IPAddress 查看一下 elasticsearch 当前IP.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">➜ ✗ docker inspect elasticsearch |grep IPAddress
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;SecondaryIPAddresses&amp;#34;: null,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;IPAddress&amp;#34;: &amp;#34;&amp;#34;,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;#34;IPAddress&amp;#34;: &amp;#34;172.27.0.2&amp;#34;,
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="启动-skywalking-ui--skywalking-collector">启动 Skywalking UI + Skywalking collector
&lt;/h2>&lt;p>dalao wutang的&lt;a class="link" href="https://hub.docker.com/r/wutang/skywalking-docker/" target="_blank" rel="noopener"
>wutang/skywalking-docker&lt;/a>已经把UI和collector打包到一个镜像里面了,完全可以独立安装.&lt;/p>
&lt;p>所以我这里采用的也是这个方案.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">docker run -p 8080:8080 -p 10800:10800 -p 11800:11800 -p 12800:12800 -e &lt;span class="nv">ES_CLUSTER_NAME&lt;/span>&lt;span class="o">=&lt;/span>elasticsearch -e &lt;span class="nv">ES_ADDRESSES&lt;/span>&lt;span class="o">=&lt;/span>上一步拿到的elasticsearchIP:9300 -d wutang/skywalking-docker:5.x
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动好了之后打开 &lt;a class="link" href="localhost:8080" >localhost:8080&lt;/a>,如果UI页面没有500/404错误,说明整个系统已经正常启动了.&lt;/p>
&lt;p>PS:默认账号密码是:admin admin,可以在docker run指定 UI_ADMIN_PASSWORD环境变量自定义密码.&lt;/p>
&lt;p>&lt;img src="https://wx4.sinaimg.cn/mw1024/64d1e863gy1fvh3iegq92j21kn0st41c.jpg"
loading="lazy"
alt="UI"
>&lt;/p>
&lt;p>如果有错误的话,大概率是ES没有连上,检查一下ES是不是还活着,再不行就进到容器里面看日志.日志默认路径:/apache-skywalking-apm-incubating/logs&lt;/p>
&lt;h3 id="agent接入">Agent接入
&lt;/h3>&lt;p>当前已经有Java/C#(dotnet core)/Node.js的Agent了.&lt;/p>
&lt;p>对应的话Java支持是最多的,其他两个我看下来基本就是主流比较多的一些框架都基本有了.&lt;/p>
&lt;p>对应agent框架链接:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>dotnet core: &lt;a class="link" href="https://github.com/OpenSkywalking/skywalking-netcore" target="_blank" rel="noopener"
>OpenSkywalking/skywalking-netcore&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>node.js:&lt;a class="link" href="https://github.com/OpenSkywalking/skywalking-nodejs" target="_blank" rel="noopener"
>OpenSkywalking/skywalking-nodejs&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>理论上应该遵循&lt;a class="link" href="http://opentracing.io/" target="_blank" rel="noopener"
>http://opentracing.io/&lt;/a> API标准的.&lt;/p>
&lt;p>Java agent 主仓库就有,直接去看release即可.&lt;/p>
&lt;p>今天我们肯定是用dotnet core 啦.&lt;/p>
&lt;p>dotnet core当前支持的库和中间件有下面这些:&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://github.com/aspnet" target="_blank" rel="noopener"
>ASP.NET Core&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/dotnet/corefx" target="_blank" rel="noopener"
>.NET Core BCL types (HttpClient and SqlClient)&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/aspnet/EntityFrameworkCore" target="_blank" rel="noopener"
>EntityFrameworkCore&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/npgsql/Npgsql.EntityFrameworkCore.PostgreSQL" target="_blank" rel="noopener"
>Npgsql.EntityFrameworkCore.PostgreSQL&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/PomeloFoundation/Pomelo.EntityFrameworkCore.MySql" target="_blank" rel="noopener"
>Pomelo.EntityFrameworkCore.MySql&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/dotnetcore/CAP" target="_blank" rel="noopener"
>CAP&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>嗯,该有的都有了.&lt;/p>
&lt;p>先引入一下&lt;a class="link" href="https://www.nuget.org/packages/SkyWalking.AspNetCore/" target="_blank" rel="noopener"
>SkyWalking.AspNetCore&lt;/a>的Package.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">dotnet add package SkyWalking.AspNetCore --version 0.3.0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>酌情新增 SkyWalking.Diagnostics.EntityFrameworkCore, SkyWalking.Diagnostics.HttpClient, SkyWalking.Diagnostics.EntityFrameworkCore.Npgsql,SkyWalking.Diagnostics.EntityFrameworkCore.Pomelo.MySql 等等&amp;hellip;&lt;/p>
&lt;p>或者直接在xxx.csproj 新增下面这些包.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;PackageReference&lt;/span> &lt;span class="na">Include=&lt;/span>&lt;span class="s">&amp;#34;SkyWalking.AspNetCore&amp;#34;&lt;/span> &lt;span class="na">Version=&lt;/span>&lt;span class="s">&amp;#34;0.3.0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;PackageReference&lt;/span> &lt;span class="na">Include=&lt;/span>&lt;span class="s">&amp;#34;SkyWalking.Diagnostics.EntityFrameworkCore&amp;#34;&lt;/span> &lt;span class="na">Version=&lt;/span>&lt;span class="s">&amp;#34;0.3.0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;PackageReference&lt;/span> &lt;span class="na">Include=&lt;/span>&lt;span class="s">&amp;#34;SkyWalking.Diagnostics.HttpClient&amp;#34;&lt;/span> &lt;span class="na">Version=&lt;/span>&lt;span class="s">&amp;#34;0.3.0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;PackageReference&lt;/span> &lt;span class="na">Include=&lt;/span>&lt;span class="s">&amp;#34;SkyWalking.Diagnostics.EntityFrameworkCore.Npgsql&amp;#34;&lt;/span> &lt;span class="na">Version=&lt;/span>&lt;span class="s">&amp;#34;0.3.0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;PackageReference&lt;/span> &lt;span class="na">Include=&lt;/span>&lt;span class="s">&amp;#34;SkyWalking.Diagnostics.EntityFrameworkCore.Pomelo.MySql&amp;#34;&lt;/span> &lt;span class="na">Version=&lt;/span>&lt;span class="s">&amp;#34;0.3.0&amp;#34;&lt;/span>&lt;span class="nt">/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后在 Startup.cs的ConfigureServices 方法中添加引用&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-C#" data-lang="C#">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// using SkyWalking.AspNetCore;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// using SkyWalking.Diagnostics.EntityFrameworkCore;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// using SkyWalking.Diagnostics.HttpClient;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// using SkyWalking.Diagnostics.SqlClient;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">services&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddSkyWalking&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">option&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">option&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ApplicationCode&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;my-first-api&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">option&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DirectServers&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;127.0.0.1:11800&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 每三秒采样的Trace数量,-1 为全部采集&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">option&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">SamplePer3Secs&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">-&lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}).&lt;/span>&lt;span class="n">AddEntityFrameworkCore&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="n">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">AddPomeloMysql&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="p">})&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">AddHttpClient&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接着启动应用.&lt;/p>
&lt;p>看到有类似的日志输入,说明已经应用已经正常连接到SkyWalking了.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">info: SkyWalking.Remote.GrpcApplicationService[0]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Register application instance success. [applicationInstanceId] = 31
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">SkyWalking.Remote.GrpcApplicationService:Information: Register application instance success. [applicationInstanceId] = 31
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">info: SkyWalking.Remote.GrpcApplicationService[0]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Register application instance success. [applicationInstanceId] = 31
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这时候我们打开&lt;a class="link" href="http://localhost:8080/#/monitor/dashboard" target="_blank" rel="noopener"
>http://localhost:8080/#/monitor/dashboard&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://wx1.sinaimg.cn/mw1024/64d1e863gy1fvh43zghu1j21jp0jugnp.jpg"
loading="lazy"
alt="2"
>&lt;/p>
&lt;p>可以看到APP已经有数量了.&lt;/p>
&lt;p>接着我们访问一下已有的API/Web页面,就能看到对应的信息了.&lt;/p>
&lt;p>&lt;img src="https://wx2.sinaimg.cn/mw1024/64d1e863gy1fvh4ctdxzyj21jp0nzjuc.jpg"
loading="lazy"
alt="3"
>&lt;/p>
&lt;p>点一下对应的URL.&lt;/p>
&lt;p>&lt;img src="https://wx1.sinaimg.cn/mw1024/64d1e863gy1fvh4qdgglvj21kf0s377r.jpg"
loading="lazy"
alt="4"
>&lt;/p>
&lt;p>http client请求(其实是查询ES):&lt;/p>
&lt;p>&lt;img src="https://wx1.sinaimg.cn/mw1024/64d1e863gy1fvh4qdgglvj21kf0s377r.jpg"
loading="lazy"
alt="5"
>&lt;/p>
&lt;p>Topology Map&lt;/p>
&lt;p>&lt;img src="https://wx2.sinaimg.cn/mw1024/64d1e863gy1fvh4wixvq2j21iw0n0q4y.jpg"
loading="lazy"
alt="234"
>&lt;/p>
&lt;p>其他的一些功能就看自己玩了.&lt;/p>
&lt;p>本期结束&amp;hellip;&lt;/p></description></item><item><title>可能是全网首个支持阿里云Elasticsearch Xapck鉴权的Skywalking</title><link>https://liguobao.github.io/p/%E5%8F%AF%E8%83%BD%E6%98%AF%E5%85%A8%E7%BD%91%E9%A6%96%E4%B8%AA%E6%94%AF%E6%8C%81%E9%98%BF%E9%87%8C%E4%BA%91elasticsearch-xapck%E9%89%B4%E6%9D%83%E7%9A%84skywalking/</link><pubDate>Mon, 18 Jun 2018 00:00:00 +0000</pubDate><guid>https://liguobao.github.io/p/%E5%8F%AF%E8%83%BD%E6%98%AF%E5%85%A8%E7%BD%91%E9%A6%96%E4%B8%AA%E6%94%AF%E6%8C%81%E9%98%BF%E9%87%8C%E4%BA%91elasticsearch-xapck%E9%89%B4%E6%9D%83%E7%9A%84skywalking/</guid><description>&lt;h1 id="可能是全网首个支持阿里云elasticsearch-xapck鉴权的skywalking">可能是全网首个支持阿里云Elasticsearch Xapck鉴权的Skywalking
&lt;/h1>&lt;p>对Skywalking有兴趣的同学参见:&lt;a class="link" href="https://zhuanlan.zhihu.com/p/45084693" target="_blank" rel="noopener"
>年轻人的第一个APM-Skywalking&lt;/a>&lt;/p>
&lt;p>之前在搭建Skywalking的时候发现,官方Skywalking 5.X并支持有鉴权的Elasticsearch.&lt;/p>
&lt;p>而我司有其他需求已经购买了阿里云的Elasticsearch,咨询过阿里云技术支持后他们表示并不能去掉鉴权,所以只好自己想办法了.&lt;/p>
&lt;p>又在Skywalking技术群问了一圈,有其他人也遇到过类似的问题,但是最后还是选择自建ES了.&lt;/p>
&lt;p>实在不想自己再浪费精力去搭建ES了,还是觉得可以尝试一下别的方案.&lt;/p>
&lt;p>然后咨询了一下wusheng大大之后,他说可以自己尝试换一个支持XPack鉴权的Client,应该没什么太大的问题.&lt;/p>
&lt;p>于是就开始了&amp;quot;填坑&amp;quot;之旅.&lt;/p>
&lt;h2 id="首先是引入x-pack-transport支持">首先是引入x-pack-transport支持
&lt;/h2>&lt;p>apm-collector/apm-collector-component/client-component/pom.xml&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;groupId&amp;gt;&lt;/span>org.elasticsearch.client&lt;span class="nt">&amp;lt;/groupId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;artifactId&amp;gt;&lt;/span>x-pack-transport&lt;span class="nt">&amp;lt;/artifactId&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;version&amp;gt;&lt;/span>${elasticsearch.client.version}&lt;span class="nt">&amp;lt;/version&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/dependency&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;repositories&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;repository&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;id&amp;gt;&lt;/span>elasticsearch-releases&lt;span class="nt">&amp;lt;/id&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;url&amp;gt;&lt;/span>https://artifacts.elastic.co/maven&lt;span class="nt">&amp;lt;/url&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;releases&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;enabled&amp;gt;&lt;/span>true&lt;span class="nt">&amp;lt;/enabled&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/releases&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;snapshots&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;enabled&amp;gt;&lt;/span>false&lt;span class="nt">&amp;lt;/enabled&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/snapshots&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/repository&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;lt;/repositories&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>接着在 &amp;hellip;in/java/org/apache/skywalking/apm/collector/client/elasticsearch/ElasticSearchClient.java&lt;/p>
&lt;p>加入PreBuiltXPackTransportClient的初始化&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">securityUser&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PreBuiltXPackTransportClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">initXPackClient&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Settings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">settings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Settings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cluster.name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;xpack.security.transport.ssl.enabled&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;xpack.security.user&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">securityUser&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;client.transport.sniff&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PreBuiltXPackTransportClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">settings&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PreBuiltTransportClient&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">initClient&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Settings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">settings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Settings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Settings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">settings&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Settings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">builder&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cluster.name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;cluster.name&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterName&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;client.transport.sniff&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterTransportSniffer&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">put&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;client.transport.sniff&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clusterTransportSniffer&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">return&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">new&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PreBuiltTransportClient&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">settings&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 新增 private final String securityUser;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 判断这个变量是不是null或者空字符串,如果是就默认初始化,不是则使用initXPackClient初始化&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// 改一下initialize 方法&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">private&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">final&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">String&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">securityUser&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nd">@Override&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">public&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nf">initialize&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">throws&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ClientException&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">if&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">securityUser&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">null&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">||&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="na">equals&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">securityUser&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">initClient&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">else&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">client&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">initXPackClient&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>然后还要把apm-collector/pom.xml的elasticsearch.client.version 版本改成5.3.3.&lt;/p>
&lt;p>改完之后因为5.3.3和原来5.5.0有点不一样,需要修改一下很几个地方的代码.&lt;/p>
&lt;p>这时候建议直接使用IDEA build 一下,哪里报错改哪里就好.&lt;/p>
&lt;p>主要都是 searchResponse.getHits().totalHits 改成searchResponse.getHits().totalHits()&lt;/p>
&lt;p>神奇发现5.5.0版本的ES Client把5.3.3的searchResponse.getHits().totalHits() 方法改成了属性.&lt;/p>
&lt;p>不经感慨都是人才啊&amp;hellip;&lt;/p>
&lt;p>别的一些基本都是引入 import org.elasticsearch.action.bulk.byscroll.BulkByScrollResponse;&lt;/p>
&lt;p>全部代码在这里:&lt;a class="link" href="https://github.com/liguobao/incubator-skywalking/commit/ae3d43bc7a65a1b955e6bdf75a2356c8ecf53f28" target="_blank" rel="noopener"
>liguobao/incubator-skywalking&lt;/a>&lt;/p>
&lt;p>完整改好的代码在&lt;a class="link" href="https://github.com/liguobao/incubator-skywalking/commit/ae3d43bc7a65a1b955e6bdf75a2356c8ecf53f28" target="_blank" rel="noopener"
>liguobao/incubator-skywalking&lt;/a>&lt;/p>
&lt;p>同时配置的时候添加一下 securityUser参数,如果ES有鉴权就传入,没有的话就不传,这样就达到鉴权和不鉴权两种需求的兼容了.&lt;/p>
&lt;h2 id="支持xpack的docker部署方案">支持xpack的docker部署方案
&lt;/h2>&lt;p>完整原文链接:&lt;a class="link" href="https://github.com/liguobao/skywalking-docker/tree/master/5.x/standalone/all-in-one-xpack" target="_blank" rel="noopener"
>Skywalking-Dcoker for ES xpack 镜像&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://hub.docker.com/r/liguobao/skywalking-docker/" target="_blank" rel="noopener"
>&lt;img src="https://img.shields.io/docker/build/liguobao/skywalking-docker.svg"
loading="lazy"
alt="Docker Build Status"
>&lt;/a>
&lt;a class="link" href="https://hub.docker.com/r/liguobao/skywalking-docker/" target="_blank" rel="noopener"
>&lt;img src="https://img.shields.io/docker/pulls/liguobao/skywalking-docker.svg"
loading="lazy"
alt="Docker Pulls"
>&lt;/a>&lt;/p>
&lt;h2 id="dockerfile说明">Dockerfile说明
&lt;/h2>&lt;p>apache-skywalking-apm-incubating.tar.gz为支持ES X-Pack修改后打包出来的压缩包,此仓库没有这个文件的.&lt;/p>
&lt;p>可以去QQ群:Apache SkyWalking交流群(392443393)群文件中下载apache-skywalking-apm-incubating-xpack.tar.gz&lt;/p>
&lt;p>或者自行编译&lt;a class="link" href="https://github.com/liguobao/incubator-skywalking/tree/5.x" target="_blank" rel="noopener"
>liguobao/incubator-skywalking/tree/5.x&lt;/a> 此版本的源码.&lt;/p>
&lt;p>编译步骤:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Prepare git, JDK8 and maven3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/liguobao/incubator-skywalking.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> incubator-skywalking/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git checkout 5.x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#Switch to the tag by using git checkout [tagname] (Optional, switch if want to build a release from source codes)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git submodule init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git submodule update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Run ./mvnw clean package -DskipTests
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#All packages are in /dist.(.tar.gz for Linux and .zip for Windows).&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Docker 镜像名称:&lt;a class="link" href="https://hub.docker.com/r/liguobao/skywalking-docker/" target="_blank" rel="noopener"
>liguobao/skywalking-docker&lt;/a>&lt;/p>
&lt;h2 id="拉取镜像pull-image">拉取镜像（Pull Image）:
&lt;/h2>&lt;p>&lt;code>docker pull liguobao/skywalking-docker:5.0.RC2.xpack&lt;/code>&lt;/p>
&lt;h2 id="运行镜像runfor-es-xpack">运行镜像（Run）for ES xpack:
&lt;/h2>&lt;ul>
&lt;li>&lt;code>docker run -p 8080:8080 -p 10800:10800 -p 11800:11800 -p 12800:12800 -e ES_CLUSTER_NAME=elasticsearch -e ES_ADDRESSES=192.168.2.96:9300 -e SECURITY_USER='elastic:password' -d liguobao/skywalking-docker:5.0.RC2.xpack&lt;/code>&lt;/li>
&lt;li>使用浏览器访问&lt;code>http://localhost:8080&lt;/code>即可.&lt;/li>
&lt;li>日志挂载 &lt;code>-v /your/log/path:/apache-skywalking-apm-incubating/logs&lt;/code>&lt;/li>
&lt;/ul>
&lt;h2 id="环境变量environment-variables">环境变量（Environment Variables）
&lt;/h2>&lt;ul>
&lt;li>&lt;code>ES_CLUSTER_NAME&lt;/code>,&lt;code>ES_ADDRESSES&lt;/code>:elasticsearch 地址和集群名称。注意：此处Elasticsearch地址中的端口务必是Elasticsearch TCP端口。&lt;/li>
&lt;li>&lt;code>SECURITY_USER&lt;/code>,&lt;code>SECURITY_USER&lt;/code>:elasticsearch 的账号密码,使用X-Pack实现的,常见阿里云ES,格式为:&amp;lsquo;user:password&amp;rsquo;.此参数不传入或者传入&amp;rsquo;&amp;rsquo; ,默认使用没有授权的client.&lt;/li>
&lt;li>&lt;code>NAMING_BIND_HOST&lt;/code>,&lt;code>NAMING_BIND_PORT&lt;/code>:OS real network IP(binding required),for agent to find collector cluster.&lt;/li>
&lt;li>&lt;code>BIND_HOST&lt;/code>,&lt;code>REMOTE_BIND_PORT&lt;/code>:OS real network IP(binding required),for collector nodes communicate with each other in cluster. collectorN &amp;ndash;(gRPC) &amp;ndash;&amp;gt; collectorM&lt;/li>
&lt;li>&lt;code>AGENT_GRPC_BIND_PORT&lt;/code>:OS real network IP(binding required),for agent to uplink data(trace/metrics) to collector. agent&amp;ndash;(gRPC)&amp;ndash;&amp;gt; collector&lt;/li>
&lt;li>&lt;code>AGENT_JETTY_BIND_HOST&lt;/code>,&lt;code>AGENT_JETTY_BIND_PORT&lt;/code>:OS real network IP(binding required), for agent to uplink data(trace/metrics) to collector through HTTP. agent&amp;ndash;(HTTP)&amp;ndash;&amp;gt; collector
-&lt;code>UI_JETTY_BIND_HOST&lt;/code>,&lt;code>UI_JETTY_BIND_PORT&lt;/code>:Stay in &lt;code>0.0.0.0&lt;/code> if UI starts up in default mode.Change it to OS real network IP(binding required), if deploy collector in different machine.&lt;/li>
&lt;/ul>
&lt;h2 id="与elasticsearch-shanghai-zone镜像配合使用请参考">与elasticsearch-shanghai-zone镜像配合使用请参考
&lt;/h2>&lt;ul>
&lt;li>&lt;a class="link" href="../../../elasticsearch-5.6.10-Zone-Asia-SH/README.md" >wutang/elasticsearch-shanghai-zone&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="../5.x/quick-start/README.md" >quick start&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="后记">后记
&lt;/h2>&lt;p>本来还打算把代码提给主仓库的,但是wusheng 大大说xpack客户端和Apache要求的授权有冲突,遂&amp;hellip;&lt;/p>
&lt;p>那就留着自己玩了.&lt;/p>
&lt;p>拜&amp;hellip;&lt;/p></description></item></channel></rss>